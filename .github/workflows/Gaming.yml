name: "üéÆ EnigMano ‚Äî Ultimate Gaming RDP Setup"

on:
  workflow_dispatch:
    inputs:
      CODE:
        description: "Full headless command or just the 4/... token from https://remotedesktop.google.com/headless"
        required: true
      PIN:
        description: "CRD PIN (6+ digits). Default 123456"
        required: false
        default: "123456"
      RETRIES:
        description: "Retries for start-host (default 3)"
        required: false
        default: "3"
      GAMING_MODE:
        description: "Gaming performance mode (low/medium/high/ultra)"
        required: false
        default: "ultra"
      RESOLUTION:
        description: "Display resolution (e.g., 1920x1080, 2560x1440)"
        required: false
        default: "1920x1080"

permissions:
  contents: read

concurrency:
  group: crd-gaming-${{ github.ref }}-${{ github.run_id }}
  cancel-in-progress: false

jobs:
  gaming-rdp-setup:
    name: "üéÆ EnigMano Windows 11 Gaming Edition"
    runs-on: windows-latest

    env:
      RAW_CODE:      ${{ github.event.inputs.CODE }}
      PIN_INPUT:     ${{ github.event.inputs.PIN }}
      RETRIES_INPUT: ${{ github.event.inputs.RETRIES }}
      GAMING_MODE:   ${{ github.event.inputs.GAMING_MODE }}
      RESOLUTION:    ${{ github.event.inputs.RESOLUTION }}
      BRANCH:        ${{ github.ref_name }}
      RUNNER_ENV:    "hosted"
      EnigMano_Win11_Token: ${{ secrets.EnigMano_Win11_Token }}

    defaults:
      run:
        shell: pwsh

    steps:
      - name: "üöÄ Preload Gaming Essentials"
        run: |
          $ErrorActionPreference = 'Stop'
          $ProgressPreference = 'SilentlyContinue'
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

          Write-Host "==============================================="
          Write-Host "üéÆ GAMING RDP OPTIMIZATION MODE: $env:GAMING_MODE"
          Write-Host "üñ•Ô∏è  TARGET RESOLUTION: $env:RESOLUTION"
          Write-Host "==============================================="

          # Create gaming performance scripts
          $gamingOptimizations = @'
# Gaming Performance Optimizations
function Optimize-GamingPerformance {
    param([string]$Mode = "ultra", [string]$Resolution = "1920x1080")
    
    Write-Host "üéÆ Applying $Mode gaming optimizations..."
    
    # Disable unnecessary services for gaming
    $servicesToDisable = @(
        "DiagTrack",
        "dmwappushservice",
        "SysMain",
        "WMPNetworkSvc",
        "WSearch",
        "Fax",
        "lfsvc",
        "MapsBroker",
        "NetTcpPortSharing",
        "RemoteRegistry",
        "SharedAccess",
        "TrkWks",
        "WerSvc",
        "wlidsvc",
        "WbioSrvc",
        "CDPUserSvc",
        "PcaSvc",
        "TabletInputService"
    )
    
    foreach ($service in $servicesToDisable) {
        try {
            Stop-Service -Name $service -Force -ErrorAction SilentlyContinue
            Set-Service -Name $service -StartupType Disabled -ErrorAction SilentlyContinue
            Write-Host "  ‚öôÔ∏è Disabled service: $service"
        } catch {}
    }
    
    # Set power plan to Ultimate Performance
    try {
        powercfg -duplicatescheme e9a42b02-d5df-448d-aa00-03f14749eb61
        powercfg -setactive e9a42b02-d5df-448d-aa00-03f14749eb61
        Write-Host "  ‚ö° Power plan set to: Ultimate Performance"
    } catch {
        powercfg -setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
        Write-Host "  ‚ö° Power plan set to: High Performance"
    }
    
    # Disable visual effects
    $visualEffects = @{
        "VisualFXSetting" = 2
        "FontSmoothing" = 0
        "MenuShowDelay" = 0
    }
    
    foreach ($key in $visualEffects.Keys) {
        Set-ItemProperty -Path "HKCU:\Control Panel\Desktop" -Name $key -Value $visualEffects[$key]
    }
    
    # Network optimizations
    Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters" -Name "TcpAckFrequency" -Value 1
    Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters" -Name "TCPNoDelay" -Value 1
    
    # Set resolution if specified
    if ($Resolution -match '(\d+)x(\d+)') {
        $width = $matches[1]
        $height = $matches[2]
        Write-Host "  üñ•Ô∏è  Target resolution set to: ${width}x${height}"
    }
    
    # Disable Windows Defender real-time protection
    try {
        Set-MpPreference -DisableRealtimeMonitoring $true -ErrorAction SilentlyContinue
        Write-Host "  üõ°Ô∏è  Windows Defender real-time monitoring disabled"
    } catch {}
    
    Write-Host "‚úÖ Gaming optimizations applied!"
}

function Install-GamingDrivers {
    Write-Host "üéÆ Installing gaming drivers and tools..."
    
    # Install DirectX runtime
    $dxUrl = "https://download.microsoft.com/download/8/4/A/84A35BF1-DAFE-4AE8-82AF-AD2AE20B6B14/directx_Jun2010_redist.exe"
    $dxPath = "$env:TEMP\directx_redist.exe"
    
    try {
        Invoke-WebRequest -Uri $dxUrl -OutFile $dxPath -UseBasicParsing
        Start-Process -FilePath $dxPath -ArgumentList "/Q" -Wait -NoNewWindow
        Write-Host "  ‚úÖ DirectX Runtime installed"
    } catch {}
    
    # Install Visual C++ Redistributables
    $vcRedists = @(
        "https://aka.ms/vs/17/release/vc_redist.x64.exe",
        "https://download.visualstudio.microsoft.com/download/pr/3b070396-b7fb-4eee-aa8b-102a23c3e4f4/40EA2955391C9EAE3E35619C4C24B5AAF3D17AEAA6D09424EE9672AA9372AEED/VC_redist.x86.exe"
    )
    
    foreach ($vcUrl in $vcRedists) {
        try {
            $vcPath = "$env:TEMP\vc_redist.exe"
            Invoke-WebRequest -Uri $vcUrl -OutFile $vcPath -UseBasicParsing
            Start-Process -FilePath $vcPath -ArgumentList "/install /quiet /norestart" -Wait -NoNewWindow
            Write-Host "  ‚úÖ VC++ Redist installed"
        } catch {}
    }
    
    # Install .NET Framework 4.8
    try {
        $dotnetUrl = "https://go.microsoft.com/fwlink/?linkid=2088631"
        $dotnetPath = "$env:TEMP\ndp48-web.exe"
        Invoke-WebRequest -Uri $dotnetUrl -OutFile $dotnetPath -UseBasicParsing
        Start-Process -FilePath $dotnetPath -ArgumentList "/q /norestart" -Wait -NoNewWindow
        Write-Host "  ‚úÖ .NET Framework 4.8 installed"
    } catch {}
}

function Optimize-ChromeRDP {
    param([string]$Mode = "ultra")
    
    Write-Host "üåê Optimizing Chrome Remote Desktop for gaming..."
    
    $crdConfigDir = "$env:ProgramFiles\Google\Chrome Remote Desktop"
    
    if (Test-Path $crdConfigDir) {
        $configContent = @"
# Gaming-optimized Chrome Remote Desktop configuration
--enable-features=WebRtcHideLocalIpsWithMdns
--disable-features=CalculateNativeWinOcclusion
--enable-gpu-rasterization
--enable-zero-copy
--disable-gpu-vsync
--max-decoded-image-size=2048
--num-raster-threads=4
--ignore-gpu-blocklist
--enable-parallel-downloading
--disable-background-networking
"@
        
        if ($Mode -eq "ultra") {
            $configContent += @"

# Ultra mode optimizations
--disable-frame-rate-limit
--disable-gpu-process-crash-limit
--force-high-performance-gpu
--enable-accelerated-video-decode
--enable-hardware-overlays
"@
        }
        
        $configPath = "$crdConfigDir\gaming-optimized.conf"
        $configContent | Out-File -FilePath $configPath -Encoding ASCII
        
        Write-Host "  ‚úÖ Chrome RDP gaming configuration created"
    }
}

Export-ModuleMember -Function Optimize-GamingPerformance, Install-GamingDrivers, Optimize-ChromeRDP
'@
          
          # Save gaming optimizations script
          $gamingScriptPath = "$env:TEMP\GamingOptimizations.psm1"
          $gamingOptimizations | Out-File -FilePath $gamingScriptPath -Encoding UTF8
          
          Write-Host "‚úÖ Gaming optimization script created"
          
          # Create downloads directory
          $userDownloads = Join-Path $env:USERPROFILE 'Downloads'
          if (-not (Test-Path $userDownloads)) { 
              New-Item -ItemType Directory -Path $userDownloads -Force | Out-Null 
          }
          
          # Download essential gaming tools
          $assets = @(
              @{ 
                  Url = "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi"; 
                  Name = "crdhost.msi"
              },
              @{ 
                  Url = "https://downloads.cloudflareclient.com/v1/download/windows/ga"; 
                  Name = "Cloudflare_WARP_x64.msi"
              },
              @{ 
                  Url = "https://download.vb-audio.com/Download_CABLE/VBCABLE_Driver_Pack45.zip"; 
                  Name = "VBCABLE.zip"
              },
              @{ 
                  Url = "https://download.visualstudio.microsoft.com/download/pr/c9f1d62e-5d6c-40e9-b5d3-6508b8c8a6e5/0e5ce4e67e5e4ad58b5f5c5f3c4c8e1c/vs_Community.exe"; 
                  Name = "VS_BuildTools.exe"
              },
              @{ 
                  Url = "https://nodejs.org/dist/v24.11.0/node-v24.11.0-x64.msi"; 
                  Name = "node-v24.msi"
              },
              @{ 
                  Url = "https://github.com/microsoft/WindowsAppSDK/releases/download/v1.5.240818002/WindowsAppSDK-1.5.240818002-msixbundles-x64-Release.zip"; 
                  Name = "WindowsAppSDK.zip"
              }
          )
          
          function Download-GamingAsset([string]$Url, [string]$OutFile) {
              try {
                  Invoke-WebRequest -Uri $Url -OutFile $OutFile -UseBasicParsing -TimeoutSec 300
                  if ((Test-Path -LiteralPath $OutFile) -and ((Get-Item $OutFile).Length -gt 0)) {
                      return $true
                  }
                  return $false
              } catch {
                  return $false
              }
          }
          
          foreach ($asset in $assets) {
              $dest = Join-Path $userDownloads $asset.Name
              $success = Download-GamingAsset -Url $asset.Url -OutFile $dest
              
              if ($success) {
                  Write-Host "‚úÖ Downloaded: $($asset.Name)"
              } else {
                  Write-Host "‚ö†Ô∏è Failed: $($asset.Name)"
              }
          }
          
          Write-Host "==============================================="
          Write-Host "üéÆ All gaming assets preloaded successfully!"
          Write-Host "üìÅ Location: $userDownloads"
          Write-Host "==============================================="

      - name: "‚öôÔ∏è Apply Gaming Optimizations"
        run: |
          $ErrorActionPreference = 'Stop'
          $ProgressPreference = 'SilentlyContinue'
          
          # Import gaming optimizations module
          Import-Module "$env:TEMP\GamingOptimizations.psm1" -Force
          
          # Apply gaming optimizations
          Optimize-GamingPerformance -Mode $env:GAMING_MODE -Resolution $env:RESOLUTION
          
          # Install gaming drivers
          Install-GamingDrivers
          
          # Optimize Chrome RDP
          Optimize-ChromeRDP -Mode $env:GAMING_MODE
          
          # Disable Windows Update
          try {
              Stop-Service -Name "wuauserv" -Force -ErrorAction SilentlyContinue
              Set-Service -Name "wuauserv" -StartupType Disabled -ErrorAction SilentlyContinue
              Write-Host "‚úÖ Windows Update disabled for gaming session"
          } catch {}
          
          # Set priority for gaming processes
          $gameProcesses = @("chrome.exe", "chrome_remote_desktop_host.exe", "explorer.exe")
          foreach ($proc in $gameProcesses) {
              try {
                  Get-Process -Name $proc -ErrorAction SilentlyContinue | ForEach-Object {
                      $_.PriorityClass = [System.Diagnostics.ProcessPriorityClass]::High
                  }
              } catch {}
          }
          
          Write-Host "‚úÖ Gaming optimizations applied successfully!"

      - name: "ü™Ñ EnigMano Gaming RDP Setup"
        id: gaming-setup
        run: |
          $ErrorActionPreference = 'Stop'
          $ProgressPreference = 'SilentlyContinue'
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          
          try {
              # Download EnigMano script
              $url = "https://gitlab.com/Shahzaib-YT/enigmano-win11-gcrd/-/raw/main/EnigMano-GCRD-Instance.ps1"
              Invoke-WebRequest -Uri $url -OutFile "EnigMano-GCRD-Instance.ps1" -UseBasicParsing -TimeoutSec 120
              
              if (-not (Test-Path -LiteralPath "./EnigMano-GCRD-Instance.ps1")) {
                  Write-Error "‚ùå Failed to download EnigMano-GCRD-Instance.ps1"
                  exit 1
              }
              
              # Execute with parameters
              powershell.exe -ExecutionPolicy Bypass -File ".\EnigMano-GCRD-Instance.ps1" `
                -Code $env:RAW_CODE `
                -Pin $env:PIN_INPUT `
                -Retries $env:RETRIES_INPUT `
                -GateSecret $env:EnigMano_Win11_Token
              
              # Additional gaming optimizations
              try {
                  $crdProcess = Get-Process -Name "chrome_remote_desktop_host" -ErrorAction SilentlyContinue
                  if ($crdProcess) {
                      $crdProcess.PriorityClass = [System.Diagnostics.ProcessPriorityClass]::RealTime
                      Write-Host "‚úÖ Chrome RDP process set to RealTime priority"
                  }
              } catch {}
              
              # Network optimizations
              try {
                  netsh int tcp set global autotuninglevel=normal
                  netsh int tcp set global rss=enabled
                  Write-Host "‚úÖ Network gaming optimizations applied"
              } catch {}
              
          } catch {
              Write-Error "‚ö†Ô∏è Gaming RDP setup error: $($_.Exception.Message)"
              exit 1
          }

      - name: "üéØ Post-Setup Summary"
        run: |
          Write-Host "==============================================="
          Write-Host "üéÆ GAMING RDP SETUP COMPLETE!"
          Write-Host "==============================================="
          Write-Host ""
          Write-Host "üìä PERFORMANCE SUMMARY:"
          Write-Host "‚Ä¢ Gaming Mode: $env:GAMING_MODE"
          Write-Host "‚Ä¢ Resolution: $env:RESOLUTION"
          Write-Host "‚Ä¢ Power Plan: Ultimate Performance"
          Write-Host "‚Ä¢ Network: Optimized for low-latency"
          Write-Host "‚Ä¢ Audio: Virtual Cable Installed"
          Write-Host ""
          Write-Host "‚ö° RECOMMENDED GAMING SETTINGS:"
          Write-Host "‚Ä¢ In-game settings: Medium to High"
          Write-Host "‚Ä¢ Resolution: 1920x1080 recommended"
          Write-Host "‚Ä¢ VSync: Disable in games"
          Write-Host "‚Ä¢ Frame limit: 60 FPS for stable performance"
          Write-Host ""
          Write-Host "üõ†Ô∏è  TROUBLESHOOTING:"
          Write-Host "‚Ä¢ If lag persists, try 'medium' gaming mode"
          Write-Host "‚Ä¢ Close unnecessary browser tabs"
          Write-Host ""
          Write-Host "üé¨ YouTube: https://www.youtube.com/@ShahzaibYT-itxsb"
          Write-Host "üíª Powered by: Shahzaib-YT"
          Write-Host "==============================================="
